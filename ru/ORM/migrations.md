# Миграции (Migrations)

[[toc]]

## Введение

При совместной разработке приложений несколькими людьми, если нет единого спецификации для синхронизации структуры базы данных, чтобы обеспечить согласованность локальных данных всех разработчиков, это будет катастрофой. Миграции базы данных предназначены для решения этой проблемы. Структура базы данных контролируется версиями, чтобы обеспечить согласованность структуры базы данных всех разработчиков.

## Создание Миграций

Используйте команду `make:migration` для создания миграции:

```go
go run . artisan make:migration create_users_table
```

Эта команда создаст файлы миграции в директории `database/migrations`. Все файлы миграции начинаются с отметки времени (timestamp). Goravel использует отметку времени для определения порядка выполнения файлов миграции. Все файлы миграции - это файлы `.sql`, и вы можете настраивать структуру таблицы с помощью SQL-запросов.

Команда миграции создаст два файла миграции одновременно: `***.up.sql` и `***.down.sql`, соответственно для выполнения и отката.

## Выполнение Миграций

Чтобы выполнить все отложенные миграции, выполните команду `migrate`:

```
go run . artisan migrate
```

Если вы хотите увидеть, какие миграции были выполнены до сих пор, вы можете использовать команду `migrate:status`:

```
go run . artisan migrate:status
```

## Откат Миграций

Чтобы отменить последнюю операцию миграции, используйте команду `rollback`. Эта команда отменяет последний "батч" миграций, который может включать несколько файлов миграции:

```
go run . artisan migrate:rollback
```

Вы можете откатить ограниченное количество миграций, указав параметр `step` для команды `rollback`. Например, следующая команда откатит последние пять миграций:

```
go run . artisan migrate:rollback --step=5
```

Команда `migrate:reset` откатит все миграции вашего приложения:

```
go run . artisan migrate:reset
```

### Откат и Повторное Применение Миграций в Один Шаг

Команда `migrate:refresh` откатит все миграции и затем выполнит команду `migrate`. Эта команда фактически пересоздает всю базу данных:

```
go run . artisan migrate:refresh
```

Вы можете откатить и повторно применить ограниченное количество миграций, указав параметр `step` для команды `refresh`. Например, следующая команда откатит последние пять миграций и повторно применит их:

```
go run . artisan migrate:refresh --step=5
```

### Очистка Всех Таблиц и Применение Миграций

Команда `migrate:fresh` удалит все таблицы из базы данных и затем выполнит команду `migrate`:

```
go run . artisan migrate:fresh
```

## Быстрое Создание

Используя `create_users_table`, автоматически будет сгенерирована таблица, содержащая инфраструктуру для `users`:

```sql
CREATE TABLE users (
  id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  created_at datetime(3) DEFAULT NULL,
  updated_at datetime(3) DEFAULT NULL,
  PRIMARY KEY (id),
  KEY idx_users_created_at (created_at),
  KEY idx_users_updated_at (updated_at)
) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = DummyDatabaseCharset;
```

Принцип реализации заключается в сопоставлении согласно регулярному выражению:

```
^create_(\w+)_table$
^create_(\w+)$
```

Используя `add_avatar_to_users_table`, будет автоматически создана структура для добавления поля в таблицу `users`:

```sql
ALTER TABLE users ADD column varchar(255) COMMENT '';
```

Принцип реализации заключается в сопоставлении согласно регулярному выражению:

```
_(to|from|in)_(\w+)_table$
_(to|from|in)_(\w+)$
```

Когда вышеуказанные условия не выполняются, фреймворк создаст пустой файл миграции.

<CommentService/>